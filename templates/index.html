{% extends "base.html" %}
{% block title %}–ì–ª–∞–≤–Ω–∞—è{% endblock %}
{% block content %}
<h1>–°–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h1>
{% if current_user.is_authenticated and current_user.role == 'admin' %}
<div class="actions-bar">
    <a href="{{ url_for('add_equipment') }}" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</a>
    <a href="{{ url_for('export_csv') }}" class="btn">–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</a>
</div>
{% endif %}
<form method="get" class="filters">
    –ö–∞—Ç–µ–≥–æ—Ä–∏—è:
    <select name="category">
        <option value="">–í—Å–µ</option>
        {% for cat in categories %}
            <option value="{{ cat.id }}" {% if request.args.get('category')|int == cat.id %}selected{% endif %}>{{ cat.name }}</option>
        {% endfor %}
    </select>
    –°—Ç–∞—Ç—É—Å:
    <select name="status">
        <option value="">–í—Å–µ</option>
        {% for s in statuses %}
            <option value="{{ s }}" {% if request.args.get('status') == s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
    </select>
    –î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏: <input type="date" name="date_from" value="{{ request.args.get('date_from', '') }}"> ‚Äî <input type="date" name="date_to" value="{{ request.args.get('date_to', '') }}">
    <button type="submit">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
</form>
<table>
    <thead>
        <tr>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th>–ò–Ω–≤–µ–Ω—Ç–∞—Ä–Ω—ã–π –Ω–æ–º–µ—Ä</th>
            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
            <th>
                {% set args = request.args.to_dict(flat=True) %}
                {% set current_sort = request.args.get('sort', 'purchase_date') %}
                {% set current_order = request.args.get('order', 'desc') %}
                
                {% set next_order = 'asc' if current_order == 'desc' else 'desc' %}
                {% set order_indicator = '‚ñº' if current_order == 'desc' else '‚ñ≤' %}
                
                {%- do args.pop('sort', None) -%}
                {%- do args.pop('order', None) -%}
                
                <a href="{{ url_for('index', sort='purchase_date', order=next_order, **args) }}">
                    –î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏ {{ order_indicator if current_sort == 'purchase_date' else '' }}
                </a>
            </th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
    </thead>
    <tbody>
        {% for item in equipment %}
        <tr>
            <td>{{ item.name }}</td>
            <td>{{ item.inventory_number }}</td>
            <td>{{ item.category.name }}</td>
            <td>{{ item.purchase_date }}</td>
            <td>{{ item.status }}</td>
            <td>
                <a href="{{ url_for('view_equipment', id=item.id) }}">üëÅÔ∏è</a>
                {% if current_user.is_authenticated and current_user.role == 'admin' %}
                    <a href="#" class="delete-btn" data-id="{{ item.id }}" data-name="{{ item.name }}">üóëÔ∏è</a>
                    <a href="{{ url_for('edit_equipment', id=item.id) }}">‚úèÔ∏è</a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.role in ['admin', 'tech'] %}
                    <a href="{{ url_for('add_maintenance', equipment_id=item.id) }}">üõ†Ô∏è</a>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<div class="pagination">
    {% if pagination.has_prev %}
        <a href="{{ url_for('index', page=pagination.prev_num, **request.args.to_dict(flat=True)) }}">–ù–∞–∑–∞–¥</a>
    {% endif %}
    –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ pagination.page }} –∏–∑ {{ pagination.pages }}
    {% if pagination.has_next %}
        <a href="{{ url_for('index', page=pagination.next_num, **request.args.to_dict(flat=True)) }}">–í–ø–µ—Ä–µ–¥</a>
    {% endif %}
</div>
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div id="deleteModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:8px; min-width:300px;">
    <h2>–£–¥–∞–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h2>
    <p id="deleteMessage"></p>
    <form id="deleteForm" method="post">
      <button type="submit">–î–∞</button>
      <button type="button" onclick="document.getElementById('deleteModal').style.display='none'">–ù–µ—Ç</button>
    </form>
  </div>
</div>
<script>
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const id = this.dataset.id;
      const name = this.dataset.name;
      document.getElementById('deleteMessage').textContent = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ "${name}"?`;
      document.getElementById('deleteForm').action = `/equipment/${id}/delete`;
      document.getElementById('deleteModal').style.display = 'flex';
    });
  });
</script>
{% endblock %}